name: Build Release for ATC4-HQ

on:
  push:
    branches: [ main ] # 当代码推送到 main 分支时触发
  release:
    types: [ created ] # 当创建新的 GitHub Release 时触发

jobs:
  build:
    runs-on: windows-latest # 在最新的 Windows 环境下运行

    steps:
    - name: Checkout code # 步骤1: 检出仓库代码
      uses: actions/checkout@v4

    - name: Setup .NET SDK # 步骤2: 安装 .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.x.x' # 指定 .NET 9 LTS 版本，您可以根据您的项目实际使用的版本修改

    - name: Restore dependencies # 步骤3: 恢复 NuGet 包依赖
      run: dotnet restore ./ATC4-HQ.csproj # 修复路径：假设 ATC4-HQ 文件夹在仓库根目录

    - name: Build project # 步骤4: 构建项目 (Release 配置)
      run: dotnet build ./ATC4-HQ.csproj --configuration Release --no-restore # 修复路径

    - name: Publish application # 步骤5: 发布应用程序 (生成可执行文件)
      run: dotnet publish ./ATC4-HQ.csproj --configuration Release --no-build -o publish # 修复路径

    - name: Upload build artifact # 步骤6: 上传构建产物 (publish目录)
      uses: actions/upload-artifact@v4
      with:
        name: ATC4-HQ-Publish # 产物的名称
        path: publish # 上传publish目录

  release: # 用于创建/更新 GitHub Release
    needs: build # 此作业依赖于 'build' 作业
    runs-on: windows-latest # 在最新的 Windows 环境下运行

    steps:
    - name: Checkout code # 步骤1: 检出仓库代码
      uses: actions/checkout@v4

    - name: Build Windows Installer MSI from exe file
      uses: AliceOh/CreateWindowsInstaller@1.0.0
      with:
        exefile: "./ATC4-HQ.exe"

    - name: Download build artifact # 步骤2: 下载 'build' 作业中上传的publish目录
      uses: actions/download-artifact@v4
      with:
        name: ATC4-HQ-Publish # 指定要下载的产物名称
        path: publish # 将publish目录下载到当前工作目录