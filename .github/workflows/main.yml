name: Build Release for ATC4-HQ

on:
  push:
    branches: [ main ] # 当代码推送到 main 分支时触发
  release:
    types: [ created ] # 当创建新的 GitHub Release 时触发

jobs:
  build:
    runs-on: windows-latest # 在最新的 Windows 环境下运行

    steps:
    - name: Checkout code # 步骤1: 检出仓库代码
      uses: actions/checkout@v4

    - name: Setup .NET SDK # 步骤2: 安装 .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.x.x' # 指定 .NET 9 LTS 版本，您可以根据您的项目实际使用的版本修改

    - name: Restore dependencies # 步骤3: 恢复 NuGet 包依赖
      run: dotnet restore ./ATC4-HQ.csproj # 修复路径：假设 ATC4-HQ 文件夹在仓库根目录

    - name: Build project # 步骤4: 构建项目 (Release 配置)
      run: dotnet build ./ATC4-HQ.csproj --configuration Release --no-restore # 修复路径

    - name: Publish application # 步骤5: 发布应用程序 (生成可执行文件)
      run: dotnet publish ./ATC4-HQ.csproj --configuration Release --no-build -o publish # 修复路径

    - name: Create Zip Archive of Published Output # ⭐️ 修改：使用 Compress-Archive 打包发布目录为ZIP
      run: Compress-Archive -Path ./publish/* -DestinationPath ATC4-HQ-Release-Build.zip
      # -Path ./publish/*: 指定要压缩的源路径，即 publish 目录下的所有内容
      # -DestinationPath ATC4-HQ-Release-Build.zip: 指定生成的ZIP文件的名称和位置

    - name: Upload build artifact # 步骤6: 上传构建产物 (现在上传的是ZIP文件)
      uses: actions/upload-artifact@v4
      with:
        name: ATC4-HQ-Release-Build # 产物的名称
        path: ATC4-HQ-Release-Build.zip # ⭐️ 上传的是打包好的ZIP文件

  release: # 用于创建/更新 GitHub Release
    needs: build # 此作业依赖于 'build' 作业
    runs-on: windows-latest # 在最新的 Windows 环境下运行

    steps:
    - name: Checkout code # 步骤1: 检出仓库代码
      uses: actions/checkout@v4

    - name: Download build artifact # 步骤2: 下载 'build' 作业中上传的ZIP产物
      uses: actions/download-artifact@v4
      with:
        name: ATC4-HQ-Release-Build # 指定要下载的产物名称
        path: . # 将ZIP文件下载到当前工作目录，它会创建一个同名文件夹

    - name: Create Release and Upload Assets # 步骤3: 创建或更新 Release 并上传资产
      uses: softprops/action-gh-release@v1 # 使用 softprops/action-gh-release Action
      if: startsWith(github.ref, 'refs/tags/') # 仅当工作流由标签推送触发时才运行此步骤
      with:
        files: ./ATC4-HQ-Release-Build.zip # ⭐️ 指向下载后的ZIP文件路径
        token: ${{ secrets.GITHUB_TOKEN }} # GitHub 自动提供的令牌，用于认证
    
    - name: Build Windows Installer MSI from exe file
      uses: AliceOh/CreateWindowsInstaller@1.0.0
      with:
        exefile: "./publish/ATC4-HQ.exe"
